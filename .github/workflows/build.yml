name: Build AMOLED Ironfox for armeabi-v7a

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 3 AM UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Clone this repo
        uses: actions/checkout@v3

      - name: ðŸ›  Install dependencies
        run: |
          sudo apt update
          sudo apt install -y zipalign apksigner jq default-jdk wget curl

      - name: ðŸ” Get latest Ironfox release info
        id: get_version
        run: |
          data=$(curl -s https://gitlab.com/api/v4/projects/ironfox-oss%2FIronFox/releases | jq -r '.[0]')
          version=$(echo "$data" | jq -r '.tag_name')
          apk=$(echo "$data" | jq -r '.assets.links[] | select(.name | endswith("-armeabi-v7a.apk")) | .url')
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "apk_url=$apk" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Download APK
        run: |
          wget -q "${{ steps.get_version.outputs.apk_url }}" -O latest.apk

      - name: ðŸ”§ Make build script executable
        run: chmod +x build.sh

      - name: ðŸ§ª Run build script
        run: ./build.sh

      - name: ðŸ“¦ Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: patched_signed.apk
          path: patched_signed.apk

      - name: ðŸš€ Create release
        uses: ncipollo/release-action@v1
        with:
          tag: "${{ steps.get_version.outputs.version }}-oled-armv7"
          name: "Ironfox OLED Dark ${{ steps.get_version.outputs.version }} (armeabi-v7a)"
          body: "Auto-patched AMOLED build for armeabi-v7a. Based on Ironfox ${{ steps.get_version.outputs.version }}."
          artifacts: patched_signed.apk
          allowUpdates: true
          prerelease: true
